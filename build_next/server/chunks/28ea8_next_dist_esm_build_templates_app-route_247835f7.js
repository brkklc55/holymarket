module.exports=[168975,e=>{"use strict";var t=e.i(184391),r=e.i(471323),s=e.i(983075),n=e.i(378517),a=e.i(295386),o=e.i(4201),i=e.i(632472),u=e.i(216780),l=e.i(646040),d=e.i(16173),c=e.i(695888),p=e.i(431036),f=e.i(736439),m=e.i(52097),h=e.i(785221),b=e.i(193695);e.i(153158);var R=e.i(664430),N=e.i(506452),v=e.i(522734),w=e.i(814747),x=e.i(697641),g=e.i(291577),A=e.i(783894),y=e.i(809544),k=e.i(779984),j=e.i(499243),_=e.i(801207);let E=process.env.VERCEL?w.default.join("/tmp","points.json"):w.default.join(process.cwd(),"data","points.json"),S=process.env.SUPABASE_URL,C=process.env.SUPABASE_SERVICE_ROLE_KEY,B=process.env.SUPABASE_KV_TABLE||"holymarket_kv",M=process.env.SUPABASE_POINTS_KEY||"points_db_v1",T=!!(S&&C),D=["0x33713b87bab352c46bba4953ab6cb11afe895d93","0x96a445dd060efd79ab27742de12128f24b4edaec","0x3DF3b1C5A77Ff85FF25727E54685b17171CC2526"],P=new Map;function O(e,t,r){let s=Date.now(),n=P.get(e);return!n||n.resetAt<=s?(P.set(e,{count:1,resetAt:s+r}),{ok:!0,remaining:t-1,resetAt:s+r}):n.count>=t?{ok:!1,remaining:0,resetAt:n.resetAt}:(n.count+=1,P.set(e,n),{ok:!0,remaining:t-n.count,resetAt:n.resetAt})}function I(){return new Date().toISOString()}function U(e){return e.trim().toLowerCase()}function F(){let e={users:{},devices:{},admins:{},shareBoosts:{}};return D.forEach((t,r)=>{let s=U(t);e.admins[s]={role:0===r?"superadmin":"admin",createdAt:I(),updatedAt:I()}}),e}function H(){return S&&C?(0,x.createClient)(S,C,{auth:{persistSession:!1,autoRefreshToken:!1}}):null}let q=(0,g.createPublicClient)({chain:j.baseSepolia,transport:(0,A.http)(process.env.BASE_SEPOLIA_RPC_URL||"https://base-sepolia.publicnode.com")});async function L(e){let t=H();if(!T||!t)return null;let r=U(e),{data:s,error:n}=await t.from("users").select("address,points,referrer_address,volume_eth").eq("address",r).maybeSingle();return n||!s?null:{user:String(s.address),points:Number(s.points||0),referrer:s.referrer_address?String(s.referrer_address):null,volumeBnb:Number(s.volume_eth||0)}}async function $(e){let t=H();if(!T||!t)return null;let r=Math.max(0,Math.floor(e?.offset??0)),s=Math.max(1,Math.floor(e?.limit??50)),{data:n,error:a}=await t.from("users").select("address,points").order("points",{ascending:!1}).range(r,r+s-1);return a||!n?null:n.map(e=>({user:String(e.address),points:Number(e.points||0)}))}async function K(e){let t=H();if(!T||!t)return;let r=U(e),{error:s}=await t.from("users").upsert({address:r},{onConflict:"address"});if(s)throw s}async function z(e){let t=H();if(!T||!t)return null;let r=(e.deviceId||"unknown").slice(0,128),s=U(e.address),n=I();await K(s);let a=await t.from("devices").upsert({device_id:r,last_seen_at:n},{onConflict:"device_id"});if(a.error)throw a.error;let o=await t.from("device_accounts").upsert({device_id:r,address:s,last_seen_at:n},{onConflict:"device_id,address"});if(o.error)throw o.error;let{count:i,error:u}=await t.from("device_accounts").select("address",{count:"exact",head:!0}).eq("device_id",r);if(u)throw u;return{accountsCount:i||0}}async function V(e){let t=H();if(!T||!t)return null;let r=U(e.address),s=Math.floor(Number(e.pointsDelta||0)),n=Number(e.volumeDelta||0);await K(r);let a=await L(r),o=Math.max(0,Math.floor(Number(a?.points||0)+s)),i=Number(a?.volumeBnb||0)+(Number.isFinite(n)&&n>0?n:0),{error:u}=await t.from("users").update({points:o,volume_eth:i,updated_at:I()}).eq("address",r);if(u)throw u;return{points:o,volumeBnb:i,referrer:a?.referrer||null}}async function J(e){let t,r=Math.floor(Date.now()/1e3),s=U(e.user),n=e.txHash,a=U(process.env.PREDICTION_MARKET_ADDRESS||process.env.NEXT_PUBLIC_PREDICTION_MARKET_ADDRESS||_.PREDICTION_MARKET_ADDRESS),o=await q.getTransaction({hash:n});if(!o.to)return{ok:!1,error:"Invalid tx"};if(U(o.to)!==a)return{ok:!1,error:"Tx not sent to market contract"};if(U(o.from)!==s)return{ok:!1,error:"Tx not sent from this wallet"};try{t=(0,y.decodeFunctionData)({abi:_.PREDICTION_MARKET_ABI,data:o.input})}catch{return{ok:!1,error:"Tx is not a valid contract call"}}if("bet"!==t.functionName)return{ok:!1,error:"Tx is not a bet()"};if(!o.value||o.value<=0n)return{ok:!1,error:"Bet value is zero"};let i=await q.getTransactionReceipt({hash:n}),u=r-Number((await q.getBlock({blockNumber:i.blockNumber})).timestamp);return u>600?{ok:!1,error:"Bet is too old to claim a boost"}:{ok:!0,valueBnb:Number((0,k.formatEther)(o.value)),ageSec:u}}async function X(){if(process.env.VERCEL)try{let e=w.default.join(process.cwd(),"data","points.json");!v.default.existsSync(E)&&v.default.existsSync(e)&&(v.default.mkdirSync(w.default.dirname(E),{recursive:!0}),v.default.copyFileSync(e,E))}catch{}if(!v.default.existsSync(E)){v.default.mkdirSync(w.default.dirname(E),{recursive:!0});let e=F();return v.default.writeFileSync(E,JSON.stringify(e,null,2)),e}let e=JSON.parse(v.default.readFileSync(E,"utf8"));(!e.devices||"object"!=typeof e.devices||Array.isArray(e.devices))&&(e.devices={}),(!e.admins||"object"!=typeof e.admins||Array.isArray(e.admins))&&(e.admins={}),(!e.shareBoosts||"object"!=typeof e.shareBoosts||Array.isArray(e.shareBoosts))&&(e.shareBoosts={});let t=!1;return D.forEach((r,s)=>{let n=U(r);e.admins[n]||(e.admins[n]={role:0===s?"superadmin":"admin",createdAt:I(),updatedAt:I()},t=!0)}),t&&v.default.writeFileSync(E,JSON.stringify(e,null,2)),e}async function G(e){v.default.mkdirSync(w.default.dirname(E),{recursive:!0}),v.default.writeFileSync(E,JSON.stringify(e,null,2))}async function W(){if(!T)return X();let e=H();if(!e)return X();let{data:t,error:r}=await e.from(B).select("value").eq("key",M).maybeSingle();if(r)return X();if(!t?.value){let t=F();return await e.from(B).upsert({key:M,value:t}),t}let s=t.value;(!s.devices||"object"!=typeof s.devices||Array.isArray(s.devices))&&(s.devices={}),(!s.admins||"object"!=typeof s.admins||Array.isArray(s.admins))&&(s.admins={}),(!s.shareBoosts||"object"!=typeof s.shareBoosts||Array.isArray(s.shareBoosts))&&(s.shareBoosts={});let n=!1;return D.forEach((e,t)=>{let r=U(e);s.admins[r]||(s.admins[r]={role:0===t?"superadmin":"admin",createdAt:I(),updatedAt:I()},n=!0)}),n&&await e.from(B).upsert({key:M,value:s}),s}async function Y(e){if(!T)return G(e);let t=H();if(!t)return G(e);await t.from(B).upsert({key:M,value:e})}function Z(e,t){let r=U(t),s=e.users[r];if(s)return s;let n={points:0,volumeBnb:0,createdAt:I(),updatedAt:I()};return e.users[r]=n,n}function Q(e,t,r){let s=t||"unknown";e.devices||(e.devices={});let n=U(r),a=I(),o=e.devices[s]||{accounts:[],firstSeenAt:a,lastSeenAt:a};return o.lastSeenAt=a,o.accounts.includes(n)||o.accounts.push(n),e.devices[s]=o,o}function ee(e,t){if(!t)return null;let r=U(t),s=e.admins?.[r];return s?.role||null}function et(e,t,r="admin"){let s=ee(e,t);return s?"superadmin"===r&&"superadmin"!==s?{ok:!1,role:s}:{ok:!0,role:s}:{ok:!1,role:null}}function er(e,t){let r=Math.max(0,Math.floor(t?.offset??0)),s=Math.max(1,Math.floor(t?.limit??50));return Object.entries(e.users).map(([e,t])=>({user:e,points:t.points})).sort((e,t)=>t.points-e.points).slice(r,r+s)}function es(){let e=Number(process.env.NEXT_PUBLIC_BNB_USD||process.env.BNB_USD||"300");return Number.isFinite(e)&&e>0?e:300}async function en(e){let t=new URL(e.url),r=t.searchParams.get("user"),s=t.searchParams.get("whoami"),n=t.searchParams.get("page"),a=t.searchParams.get("limit"),o=Math.max(1,Math.floor(Number(n||"1"))),i=Math.min(200,Math.max(1,Math.floor(Number(a||"50")))),u=(o-1)*i;if(s){let e=ee(await W(),s);return N.NextResponse.json({role:e})}if(r){let e=U(r),t=await L(e),s=await $({offset:u,limit:i+1});if(t||s){let e=(s||[]).slice(0,i),r=(s||[]).length>i;return N.NextResponse.json({user:t?{user:t.user,points:t.points,referrer:t.referrer}:null,leaderboard:e,page:o,limit:i,hasMore:r})}let n=await W(),a=n.users[e],l=Object.keys(n.users).length,d=er(n,{offset:u,limit:i}),c=u+d.length<l;return N.NextResponse.json({user:a?{user:e,points:a.points,referrer:a.referrer||null}:null,leaderboard:d,page:o,limit:i,hasMore:c})}let l=await $({offset:u,limit:i+1});if(l){let e=l.slice(0,i),t=l.length>i;return N.NextResponse.json({leaderboard:e,page:o,limit:i,hasMore:t})}let d=await W(),c=Object.keys(d.users).length,p=er(d,{offset:u,limit:i}),f=u+p.length<c;return N.NextResponse.json({leaderboard:p,page:o,limit:i,hasMore:f})}async function ea(e){let t,r=await W(),s=function(e){let t=e.headers.get("x-forwarded-for");if(t)return t.split(",")[0]?.trim()||"unknown";let r=e.headers.get("x-real-ip");return r?r.trim():"unknown"}(e),n=(e.headers.get("x-device-id")||"unknown").slice(0,128);try{t=await e.json()}catch{return N.NextResponse.json({error:"Invalid JSON"},{status:400})}let a=t?.action;if(!a)return N.NextResponse.json({error:"Missing action"},{status:400});if("bindReferral"===a&&!O(`bind:${s}:${n}`,10,864e5).ok||"earn"===a&&!O(`earn:${s}:${n}`,120,36e5).ok||"shareBoost"===a&&!O(`share:${s}:${n}`,30,864e5).ok)return N.NextResponse.json({error:"Rate limited"},{status:429});if("bindReferral"===a){let e=t?.user,s=t?.referrer;if(!e||!s)return N.NextResponse.json({error:"Missing user/referrer"},{status:400});let a=U(e),o=U(s);if(a===o)return N.NextResponse.json({ok:!0,skipped:!0});let i=await z({deviceId:n,address:a});if(i){if(i.accountsCount>3)return N.NextResponse.json({error:"Device account limit reached"},{status:403});await K(o);try{let e=H();if(!T||!e)return N.NextResponse.json({error:"Supabase not configured"},{status:500});let t=await L(a);if(t?.referrer)return N.NextResponse.json({ok:!0,skipped:!0,reason:"already_bound",storage:"supabase"});let{data:r,error:s}=await e.from("users").update({referrer_address:o,updated_at:I()}).eq("address",a).is("referrer_address",null).select("address");if(s)throw s;if(!r||0===r.length)return N.NextResponse.json({ok:!0,skipped:!0,reason:"already_bound",storage:"supabase"});return await V({address:a,pointsDelta:50}),await V({address:o,pointsDelta:50}),N.NextResponse.json({ok:!0,awarded:50,storage:"supabase"})}catch(e){return N.NextResponse.json({error:"Supabase write failed",detail:String(e?.message||e)},{status:500})}}if(Q(r,n,a).accounts.length>3)return await Y(r),N.NextResponse.json({error:"Device account limit reached"},{status:403});let u=Z(r,a);if(Z(r,o),u.referrer)return N.NextResponse.json({ok:!0,skipped:!0,reason:"already_bound"});u.referrer=o,u.points+=50,u.updatedAt=I();let l=r.users[o];return l.points+=50,l.updatedAt=I(),await Y(r),N.NextResponse.json({ok:!0,awarded:50,storage:"fallback"})}if("earn"===a){let e=t?.user,s=t?.amountUsd,a=t?.amountBnb;if(!e)return N.NextResponse.json({error:"Missing user"},{status:400});let o=U(e),i=await z({deviceId:n,address:o});if(i){if(i.accountsCount>3)return N.NextResponse.json({error:"Device account limit reached"},{status:403});let e=null;if(null!=s){let t=Number(s);e=Number.isFinite(t)&&t>0?t:null}else if(null!=a){let t=Number(a);Number.isFinite(t)&&t>0&&(e=t*es())}if(!e)return N.NextResponse.json({error:"Missing/invalid amountUsd or amountBnb"},{status:400});try{let t=Math.floor(10*e);if(t<=0)return N.NextResponse.json({ok:!0,earned:0,bonus:0});let r=null!=a?Number(a):0,s=await V({address:o,pointsDelta:t,volumeDelta:r}),n=0;s?.referrer&&(n=Math.floor(.1*t))>0&&await V({address:s.referrer,pointsDelta:n});let i=await $();return N.NextResponse.json({ok:!0,earned:t,bonus:n,leaderboard:i||[],storage:"supabase"})}catch(e){return N.NextResponse.json({error:"Supabase write failed",detail:String(e?.message||e)},{status:500})}}if(Q(r,n,o).accounts.length>3)return await Y(r),N.NextResponse.json({error:"Device account limit reached"},{status:403});let u=Z(r,o),l=null;if(null!=s){let e=Number(s);l=Number.isFinite(e)&&e>0?e:null}else if(null!=a){let e=Number(a);Number.isFinite(e)&&e>0&&(l=e*es())}if(!l)return N.NextResponse.json({error:"Missing/invalid amountUsd or amountBnb"},{status:400});if(null!=a){let e=Number(a);Number.isFinite(e)&&e>0&&(u.volumeBnb=Number(u.volumeBnb||0)+e)}let d=Math.floor(10*l);if(d<=0)return N.NextResponse.json({ok:!0,earned:0,bonus:0});u.points+=d,u.updatedAt=I();let c=0;if(u.referrer){let e=Z(r,u.referrer);(c=Math.floor(.1*d))>0&&(e.points+=c,e.updatedAt=I())}return await Y(r),N.NextResponse.json({ok:!0,earned:d,bonus:c,leaderboard:er(r),storage:"fallback"})}if("shareBoost"===a){let e=t?.user,s=t?.txHash,a=t?.amountUsd,o=t?.amountBnb;if(!e)return N.NextResponse.json({error:"Missing user"},{status:400});if(!s||"string"!=typeof s)return N.NextResponse.json({error:"Missing txHash"},{status:400});let i=s.trim();if(!/^0x[a-fA-F0-9]{64}$/.test(i))return N.NextResponse.json({error:"Invalid txHash"},{status:400});let u=U(e);try{let e=await J({txHash:i,user:u});if(!e.ok)return N.NextResponse.json({error:e.error},{status:400});e.valueBnb>0&&(t.amountBnb=e.valueBnb)}catch{return N.NextResponse.json({error:"Failed to validate bet tx"},{status:400})}if(Q(r,n,u).accounts.length>3)return await Y(r),N.NextResponse.json({error:"Device account limit reached"},{status:403});if(r.shareBoosts||(r.shareBoosts={}),r.shareBoosts[i])return N.NextResponse.json({ok:!0,skipped:!0,reason:"already_boosted"});let l=null;if(null!=a){let e=Number(a);l=Number.isFinite(e)&&e>0?e:null}else if(null!=o){let e=Number(o);Number.isFinite(e)&&e>0&&(l=e*es())}if(!l)return N.NextResponse.json({error:"Missing/invalid amountUsd or amountBnb"},{status:400});let d=Math.floor(10*l);if(d<=0)return N.NextResponse.json({ok:!0,extra:0,skipped:!0});let c=Z(r,u);if(c.points+=d,void 0!==t.amountBnb&&null!==t.amountBnb){let e=Number(t.amountBnb);Number.isFinite(e)&&e>0&&(c.volumeBnb=Number(c.volumeBnb||0)+e)}return c.updatedAt=I(),r.shareBoosts[i]={user:u,extra:d,createdAt:I()},await Y(r),N.NextResponse.json({ok:!0,extra:d,leaderboard:er(r)})}if("adminResetAll"===a){if(!et(r,t?.adminAddress,"superadmin").ok)return N.NextResponse.json({error:"Not authorized"},{status:403});if(r.users={},r.devices={},r.shareBoosts&&(r.shareBoosts={}),T){let e=H();if(e)try{await e.from("users").delete().not("address","is",null),await e.from("devices").delete().not("device_id","is",null),await e.from("device_accounts").delete().not("device_id","is",null),await e.from(B).delete().eq("key",M)}catch(e){console.error("Supabase deep reset failed:",e)}}return await Y(r),N.NextResponse.json({ok:!0,message:"System-wide reset complete."})}if("adminAdjust"===a){if(!et(r,t?.adminAddress,"admin").ok)return N.NextResponse.json({error:"Not authorized"},{status:403});let e=t?.user,s=t?.delta;if(!e||null==s)return N.NextResponse.json({error:"Missing user/delta"},{status:400});let n=U(e),a=Number(s);if(!Number.isFinite(a))return N.NextResponse.json({error:"Invalid delta"},{status:400});let o=Z(r,n);return o.points=Math.max(0,Math.floor(o.points+a)),o.updatedAt=I(),await Y(r),N.NextResponse.json({ok:!0,user:{user:n,points:o.points},leaderboard:er(r)})}if("adminList"===a){let e=et(r,t?.adminAddress,"admin");if(!e.ok)return N.NextResponse.json({error:"Not authorized"},{status:403});let s=Object.entries(r.admins||{}).map(([e,t])=>({address:e,role:t.role,createdAt:t.createdAt,updatedAt:t.updatedAt}));return s.sort((e,t)=>e.role===t.role?e.address.localeCompare(t.address):"superadmin"===e.role?-1:1),N.NextResponse.json({ok:!0,role:e.role,admins:s})}if("adminUpsert"===a){if(!et(r,t?.adminAddress,"superadmin").ok)return N.NextResponse.json({error:"Not authorized"},{status:403});let e=t?.target,s=t?.role;if(!e||"admin"!==s&&"superadmin"!==s)return N.NextResponse.json({error:"Missing/invalid target/role"},{status:400});let n=U(e),a=I();r.admins||(r.admins={});let o=r.admins[n];return r.admins[n]={role:s,createdAt:o?.createdAt||a,updatedAt:a},await Y(r),N.NextResponse.json({ok:!0})}if("adminRemove"===a){if(!et(r,t?.adminAddress,"superadmin").ok)return N.NextResponse.json({error:"Not authorized"},{status:403});let e=t?.target;if(!e)return N.NextResponse.json({error:"Missing target"},{status:400});let s=U(e),n=r.admins?.[s];return n?"superadmin"===n.role&&Object.values(r.admins||{}).filter(e=>"superadmin"===e.role).length<=1?N.NextResponse.json({error:"Cannot remove last superadmin"},{status:400}):(delete r.admins[s],await Y(r),N.NextResponse.json({ok:!0})):N.NextResponse.json({ok:!0,skipped:!0})}return N.NextResponse.json({error:"Unknown action"},{status:400})}e.s(["GET",()=>en,"POST",()=>ea,"runtime",0,"nodejs"],210871);var eo=e.i(210871);let ei=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/points/route",pathname:"/api/points",filename:"route",bundlePath:""},distDir:"build_next",relativeProjectDir:"",resolvedPagePath:"[project]/.gemini/antigravity/scratch/folymarket/app/api/points/route.ts",nextConfigOutput:"",userland:eo}),{workAsyncStorage:eu,workUnitAsyncStorage:el,serverHooks:ed}=ei;function ec(){return(0,s.patchFetch)({workAsyncStorage:eu,workUnitAsyncStorage:el})}async function ep(e,t,s){ei.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let N="/api/points/route";N=N.replace(/\/index$/,"")||"/";let v=await ei.prepare(e,t,{srcPage:N,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:w,params:x,nextConfig:g,parsedUrl:A,isDraftMode:y,prerenderManifest:k,routerServerContext:j,isOnDemandRevalidate:_,revalidateOnlyGenerated:E,resolvedPathname:S,clientReferenceManifest:C,serverActionsManifest:B}=v,M=(0,i.normalizeAppPath)(N),T=!!(k.dynamicRoutes[M]||k.routes[S]),D=async()=>((null==j?void 0:j.render404)?await j.render404(e,t,A,!1):t.end("This page could not be found"),null);if(T&&!y){let e=!!k.routes[S],t=k.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(g.experimental.adapterPath)return await D();throw new b.NoFallbackError}}let P=null;!T||ei.isDev||y||(P="/index"===(P=S)?"/":P);let O=!0===ei.isDev||!T,I=T&&!O;B&&C&&(0,o.setManifestsSingleton)({page:N,clientReferenceManifest:C,serverActionsManifest:B});let U=e.method||"GET",F=(0,a.getTracer)(),H=F.getActiveScopeSpan(),q={params:x,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!g.experimental.authInterrupts},cacheComponents:!!g.cacheComponents,supportsDynamicResponse:O,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:g.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s,n)=>ei.onRequestError(e,t,s,n,j)},sharedContext:{buildId:w}},L=new u.NodeNextRequest(e),$=new u.NodeNextResponse(t),K=l.NextRequestAdapter.fromNodeNextRequest(L,(0,l.signalFromNodeResponse)(t));try{let o=async e=>ei.handle(K,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${U} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${N}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),u=async n=>{var a,u;let l=async({previousCacheEntry:r})=>{try{if(!i&&_&&E&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await o(n);e.fetchMetrics=q.renderOpts.fetchMetrics;let u=q.renderOpts.pendingWaitUntil;u&&s.waitUntil&&(s.waitUntil(u),u=void 0);let l=q.renderOpts.collectedTags;if(!T)return await (0,p.sendResponse)(L,$,a,q.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(a.headers);l&&(t[h.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,s=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==r?void 0:r.isStale)&&await ei.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:I,isOnDemandRevalidate:_})},!1,j),t}},d=await ei.handleResponse({req:e,nextConfig:g,cacheKey:P,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:_,revalidateOnlyGenerated:E,responseGenerator:l,waitUntil:s.waitUntil,isMinimalMode:i});if(!T)return null;if((null==d||null==(a=d.value)?void 0:a.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",_?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),y&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let b=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return i&&T||b.delete(h.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||b.get("Cache-Control")||b.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(L,$,new Response(d.value.body,{headers:b,status:d.value.status||200})),null};H?await u(H):await F.withPropagatedContext(e.headers,()=>F.trace(d.BaseServerSpan.handleRequest,{spanName:`${U} ${N}`,kind:a.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},u))}catch(t){if(t instanceof b.NoFallbackError||await ei.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:I,isOnDemandRevalidate:_})},!1,j),T)throw t;return await (0,p.sendResponse)(L,$,new Response(null,{status:500})),null}}e.s(["handler",()=>ep,"patchFetch",()=>ec,"routeModule",()=>ei,"serverHooks",()=>ed,"workAsyncStorage",()=>eu,"workUnitAsyncStorage",()=>el],168975)}];

//# sourceMappingURL=28ea8_next_dist_esm_build_templates_app-route_247835f7.js.map